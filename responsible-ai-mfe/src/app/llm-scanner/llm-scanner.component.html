<!-- SPDX-License-Identifier: MIT
Copyright 2024 - 2025 Infosys Ltd.
"Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:
The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE."
-->

<div class="mb-3">

    <!-- Parameter Section -->
    <form #form="ngForm" class="pt-2">
        <input type="hidden" name="csrfToken" value="nonceService.getNonce()">
        <mat-accordion>
            <mat-expansion-panel class="expandInput" [expanded]="true">
                <mat-expansion-panel-header>
                    <mat-panel-title style="color: #382261;"> {{'Parameters' | uppercase}} </mat-panel-title>
                </mat-expansion-panel-header>

                <div class="panelBorder">
                    <!-- Model End Point & Model Type -->
                    <div class="d-flex mt-2">
                        <!-- Model End Point -->
                        <div class="w-50 d-flex align-items-center">
                            <div class="w-25">
                                <label style="color: #4D4D4D; font-size:13px;">MODEL END POINT</label>
                            </div>
                            <div class="w-75 d-flex align-items-center">
                                <span class="switch">
                                    <input class="form-check-input" id="modelendpointavailable" type="checkbox"
                                        name="modelendpointavailable" [(ngModel)]="isChecked"
                                        (ngModelChange)="checkendpointavailable()" />
                                    <label for="modelendpointavailable"></label>
                                </span>
                            </div>
                        </div>
                        <!-- Model Type -->
                        <div class="w-50 d-flex align-items-center">
                            <div class="w-25 text-end pe-4">
                                <label style="color: #4D4D4D; font-size:13px;">MODEL</label>
                            </div>
                            <div class="w-75 d-flex align-items-center">
                                <select class="form-select shadow-none" style="font-size: 12px" name="selectedModel" 
                                    [(ngModel)]="selectedModel">
                                    <option *ngFor="let model of Models" [value]="model.value">{{model.name}}</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Vulnerability Type & Probe -->
                    <div class="d-flex mt-2">
                        <div class="w-50 d-flex align-items-center">
                            <div class="w-25 d-flex align-items-center">
                                <label style="color: #4D4D4D; font-size:13px;">VULNERABILITY TYPE</label>
                                <mat-icon matTooltip={{matToolTip}}
                                    style="color: #727272; cursor: pointer; scale: 0.7; flex-shrink: 0;">info</mat-icon>
                            </div>
                            <div class="w-75 d-flex align-items-center">
                                <select class="form-select shadow-none" style="font-size: 12px; width: 95%;" name="selectedProbesCategory"
                                    [(ngModel)]="selectedProbesCategory" (change)="getProbesList();changeMatToolTip()">
                                    <option *ngFor="let category of probesCategory" [value]="category.value">
                                        {{category.name}}</option>
                                </select>
                            </div>
                        </div>
                        <div class="w-50 d-flex align-items-center">
                            <div class="w-25 text-end pe-4">
                                <label style="color: #4D4D4D; font-size:13px;">PROBE</label>
                            </div>
                            <div class="w-75 d-flex align-items-center">
                                <select class="form-select shadow-none" style="font-size: 12px" name="selectedProbesList"
                                    [(ngModel)]="selectedProbesList">
                                    <option *ngFor="let list of probesList" [value]="list">{{list}}</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- End Point Url -->
                    <div class="d-flex mt-2" *ngIf="modelendpointavailable">
                        <div class="w-125">
                            <label style="color: #4D4D4D; font-size:13px;">END POINT URL</label>
                        </div>
                        <div class="w-875">
                            <div class="position-relative">
                                <textarea name="modelendpointurl" class="form-control shadow-none" rows="3"
                                    #modelendpointurl="ngModel" [(ngModel)]="endpointurl"></textarea>
                                <button type="button" class="border-0 position-absolute resetIcon" style="right: 0; top: 0;">
                                    <i (click)="resetendpointurl()" class="material-icons" matTooltip="Reset">autorenew</i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Headers -->
                    <div class="d-flex mt-2" *ngIf="modelendpointavailable">
                        <div class="w-125">
                            <label style="color: #4D4D4D; font-size:13px;">HEADERS</label>
                        </div>
                        <div class="w-875">
                            <div class="position-relative">
                                <textarea name="headers" class="form-control shadow-none" rows="3"
                                    [(ngModel)]="headers"></textarea>
                                <button type="button" class="border-0 position-absolute resetIcon" style="right: 0; top: 0;">
                                    <i (click)="resetheaders()" class="material-icons" matTooltip="Reset">autorenew</i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Payload -->
                    <div class="d-flex mt-2" *ngIf="modelendpointavailable">
                        <div class="w-125">
                            <label style="color: #4D4D4D; font-size: 13px;">PAYLOAD</label>
                        </div>
                        <div class="w-875">
                            <form [formGroup]="Form">
                                <input type="hidden" name="csrfToken" value="nonceService.getNonce()">
                                <div formArrayName="payloadList">
                                    <div *ngFor="let data of payloadList.controls; let i = index" [formGroupName]="i">
                                        <div class="d-flex align-items-center mb-2">
                                            <div style="flex: 1;">
                                                <input formControlName="key" class="form-control shadow-none"
                                                    style="font-size: 12px; font-family: 'Segoe UI'">
                                            </div>
                                            <div class="d-flex align-items-center" style="flex: 1">
                                                <span style="margin-right: 10px;margin-left:5px;">:</span>
                                                <input formControlName="value" class="form-control shadow-none"
                                                    style="font-size: 12px; font-family: 'Segoe UI'">
                                            </div>
                                            <div class="d-flex">
                                                <mat-icon (click)="removePayload(i)"
                                                    style="cursor: pointer; scale: 0.7">clear</mat-icon>
                                            </div>
                                        </div>
                                    </div>
                                    <mat-icon (click)="addPayload()" style="cursor: pointer; scale: 0.7">add</mat-icon>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Prompt Variable -->
                    <div class="d-flex mt-2 align-items-center" *ngIf="modelendpointavailable">
                        <div class="w-125">
                            <label style="color: #4D4D4D; font-size:13px">PROMPT VARIABLE</label>
                        </div>
                        <div class="w-875">
                            <input name="targetendpointvariable" class="form-control shadow-none" type="text"
                                style="font-size: 12px" [(ngModel)]="promptvariable"/>
                        </div>
                    </div>

                    <!-- Submit -->
                    <div class="my-3 text-end">
                        <button mat-raised-button class="black-button"
                            (click)="onSubmit()" color="black"
                            style="color:white;background-color: black;">Submit</button>
                    </div>
                </div>
                    
            </mat-expansion-panel>
        </mat-accordion>
    </form>

    <!-- Response Section -->
    <div id="outputSection" class="d-flex flex-column mt-4" *ngIf="shimmerLoader">
        <ngx-skeleton-loader count="1" appearance="line"
            [theme]="{ 'margin-top':'2px','border-radius': '6px',width:'115px','margin-left':'10px', height: '17px'}" />
        <div class="d-flex" style="flex-direction: row;flex-wrap: nowrap;">
            <ngx-skeleton-loader count="4" appearance="line"
                [theme]="{ 'margin-top':'1px','border-radius': '6px','width':'90px','margin-left':'10px', height: '17px','margin-right':'75px'}" />
        </div>
        <ngx-skeleton-loader
            [theme]="{ 'margin-top':'2px','border-radius': '6px', width:'96%', 'margin-left':'10px', height: '17px'}" count="5"
            appearance="line">
        </ngx-skeleton-loader>
        <ngx-skeleton-loader count="1" appearance="line"
            [theme]="{ 'margin-top':'20px','border-radius': '6px',width:'115px','margin-left':'10px', height: '20px'}" />
        <div class="d-flex" style="flex-direction: row;">
            <ngx-skeleton-loader count="1" appearance="line"
                [theme]="{ 'margin-top':'3px','border-radius': '6px',width:'55px','margin-left':'10px', height: '17px'}" />
            <ngx-skeleton-loader count="1" appearance="line"
                [theme]="{ 'margin-top':'3px','border-radius': '6px',width:'90px','margin-left':'263px', height: '17px'}" />
            <ngx-skeleton-loader count="1" appearance="line"
                [theme]="{ 'margin-top':'3px','border-radius': '6px',width:'100px','margin-left':'160px', height: '17px'}" />
        </div>
        <div class="d-flex" style="flex-direction: row;">
            <ngx-skeleton-loader count="3" appearance="line"
                [theme]="{ 'margin-top':'42.5px','border-radius': '6px',width:'150px','margin-left':'10px', height: '17px'}"
                style="width:150px" />
            <ngx-skeleton-loader count="3" appearance="line"
                [theme]="{ 'margin-top':'1px','border-radius': '6px',width:'190px','margin-left':'175px', height: '70px'}"
                style="width: 190px;" />
            <ngx-skeleton-loader count="3" appearance="line"
                [theme]="{ 'margin-top':'1px','border-radius': '6px',width:'190px','margin-left':'235px', height: '70px'}"
                style="width: 190px;" />
        </div>
    </div>

    <div class="mt-3 mb-5 mainContainer" *ngIf="targetLoader">
        <div class="d-flex justify-content-between px-4 py-2">
            <label class="py-2 mainLabel">OUTPUT</label>
            <mat-checkbox [(ngModel)]="moderationCheck" (click)="checksModeration($event)" color="primary"
                [disabled]="isChecked">{{'Enable Moderation' | uppercase}}</mat-checkbox>
        </div>

        <!-- Summary -->
        <div class="px-4 py-2">
            <div class="card">
                <div class="card-header fw-normal">SUMMARY</div>
                <div class="card-body" style="height: 6.5rem; overflow-y: auto;">
                    <table class="styled-table">
                        <tr>
                            <th class="header fixed-column">Probe</th>
                            <th class="header" style="padding-left: 5px;">Detector</th>
                            <th class="header">Failed</th>
                            <th class="header">Total</th>
                        </tr>
                        <tr *ngFor="let element of scannerres.eval">
                            <td class="fixed-column">{{element.probe.split('.')[1]}}</td>
                            <td style="padding-left: 5px;">{{element.detector}} </td>
                            <td>{{element.total-element.passed}}</td>
                            <td>{{element.total}} </td>
                        </tr>
                        <tr *ngIf="scannerResAttempts.length === 0">
                            <td colspan="12">No Data</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- INFERENCING DETAIL: Prompts -->
        <div class="d-flex p-4 pt-2">
            <!-- Prompt section -->
            <div style="width: 10%;">
                <div class="tabs-carousel">
                    <div class="carousel-container">
                        <div class="d-flex tabs carousel-item" *ngFor="let len of scannerResAttempts; let i = index">
                            <div (click)="selectTab(i+1)" [class.active]="selectedTab === (i+1)">
                                Prompt {{i+1}}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Prompt and Response section -->
            <div class="d-flex" style="width: 90%;">
                <div class="card w-50 me-1">
                    <div class="card-header fw-normal">{{'PROMPT' | titlecase}}</div>
                    <div class="card-body" *ngIf="attemptPrompt.length > 0">{{attemptPrompt[selectedTab-1]}}</div>
                    <div class="card-body" *ngIf="attemptPrompt.length === 0">No Prompt loaded</div>
                </div>
    
                <div class="card w-50 ms-1">
                    <div class="card-header d-flex justify-content-between">
                        <label class="fw-normal">{{'RESPONSE' | titlecase}}</label>
                        <div class="d-flex align-items-center" *ngIf="attemptResponse.length > 0">
                            <label>{{'JUDGE SCORE' | titlecase}}</label>
                            <mat-icon style="scale: 0.7" [ngStyle]="{'color': getBackgroundColor(attemptSeverity[selectedTab-1])}">info</mat-icon>
                            : &nbsp;<span>{{attemptSeverity[selectedTab-1]}}</span>
                        </div>
                    </div>
                    <div class="card-body" *ngIf="attemptResponse.length > 0">{{attemptResponse[selectedTab-1]}}</div>
                    <div class="card-body" *ngIf="attemptResponse.length === 0">No Response loaded</div>
                </div>
            </div>
        </div>

        <!-- moderation -->
        <div [ngClass]="{ 'd-none': !moderationCheck }">
            <div class="d-flex px-4 py-0">
                <div style="width: 10%;"></div>
                <div  style="width: 90%;" class="d-flex mt-4 mb-3">
                    <p class="HeadingLabel" role="button" [ngClass]="{ 'activeTab': activeTab === 'Request Moderation' }"
                        (click)="changeTab('Request Moderation')">Request Moderation</p>
                    <p class="HeadingLabel" role="button" [ngClass]="{ 'activeTab': activeTab === 'Response Moderation' }"
                        (click)="changeTab('Response Moderation')">Response Moderation</p>
                    <p class="HeadingLabel" role="button" [ngClass]="{ 'activeTab': activeTab === 'Response Comparison' }"
                        (click)="changeTab('Response Comparison')">Response Comparison</p>
                </div>
            </div>

            <div class="d-flex p-4 pt-0" *ngIf="promptLoader" [ngClass]="{ 'd-none': !moderationCheck }">
                <div style="width: 10%;"></div>
                <div  style="width: 90%;">
                    <ngx-skeleton-loader count="1" appearance="line"
                        [theme]="{ 'margin-top':'12px','border-radius': '6px','margin-left':'18px', width: '98%', height: '18px'}" />
                    <ngx-skeleton-loader count="1" appearance="line"
                        [theme]="{ 'margin-top':'2px','border-radius': '6px','margin-left':'18px', width: '98%', height: '20px'}" />
                    <ngx-skeleton-loader count="1" appearance="line"
                        [theme]="{ 'margin-top':'2px','border-radius': '10px','margin-left':'18px', width: '98%', height: '270px'}" />
                </div>
            </div>
            <div class="d-flex p-4 pt-0" *ngIf="!promptLoader">
                <div style="width: 10%;"></div>
                <div  style="width: 90%;">
                    <div [hidden]="activeTab !== 'Request Moderation'">
                        <app-request-moderation 
                            [requestTime]="fmTimeApiResult.requestModeration" 
                            [openAITime]="fmTimeApiResult.OpenAIInteractionTime" 
                            [nemoChecksApiResponses]="nemoChecksApiResponses" 
                            [contentDetectorState]="contentDetectorState" 
                            [prompt]="attemptPrompt[selectedTab-1]" 
                            [modelName]="selectedLlmModel"
                            [llmEvalPayload]="llmEvalPayload" 
                            [templateBasedPayload]="templateBasedPayload" 
                            [requestModerationTemplates]="requestModerationTemplates" 
                            [privAnzOutput]="" 
                            [analyze]="" 
                            [fairness_response]="" 
                            [imagePromptInjection]=""
                            [imageJailbreak]="" 
                            [imageRestrictedTopic]="" 
                            [coupledModeration]="coupledModerationCheck" 
                            [hallucinationSwitchCheck]="hallucinationSwitchCheck">
                        </app-request-moderation>
                    </div>
                    <div [hidden]="activeTab !== 'Response Moderation'">
                        <app-response-moderation *ngIf="!hallucinationSwitchCheck" 
                            [responseTime]="fmTimeApiResult.responseModeration" 
                            [openAITime]="fmTimeApiResult.OpenAIInteractionTime" 
                            [nemoModerationRailRes]="nemoModerationRailRes" 
                            [openAIRes]="openAIRes" 
                            [llmEvalPayload]="llmEvalPayload"
                            [responseModerationTemplates]="responseModerationTemplates" 
                            [templateBasedPayload]="templateBasedPayload" 
                            [selectedUseCaseName]="selectedUseCaseName" 
                            [setLoadTemplateResMod]="setLoadTemplateResMod" 
                            [summaryStatus]="coupledModerationRes?.moderationResults?.requestModeration?.summary?.status"
                            [hallucinationSwitchCheck]="hallucinationSwitchCheck">
                        </app-response-moderation>
                    </div>
                    <div [hidden]="activeTab !== 'Response Comparison'">
                        <app-response-comparison 
                            [openAIRes]="openAIRes" 
                            [cotState]="cotState" 
                            [fmRes]="coupledModerationRes" 
                            [nemoModerationRailRes]="nemoModerationRailRes" 
                            [covState]="covState" 
                            [prompt]="attemptPrompt[selectedTab-1]" 
                            [tokenImpState]="tokenImpState" 
                            [gotState]="gotState" 
                            [hallucinationSwitchCheck]="hallucinationSwitchCheck"
                            [thotState]="thotState" 
                            [gEvalres]="gEvalres" 
                            [hallucinateRetrievalKeplerRes]="hallucinateRetrievalKeplerRes" 
                            [serperResponseState]="serperResponseState" 
                            [selectedUseCaseName]="selectedUseCaseName" 
                            [llmExplainState]="llmExplainState"
                            [submitFlag]="submitFlag" 
                            [selectedTranslate]="selectedTranslate" 
                            [UploadedFile]="UploadedFile" 
                            [vectorId]="vectorId" 
                            [MMImageResponse]="" 
                            [faithfulnessScore]=""
                            [relevanceScore]="" 
                            [adhernceScore]="" 
                            [correctnessScore]="" 
                            [averageScore]="" 
                            [faithfulness]="" 
                            [relevance]="" 
                            [adhernce]="" 
                            [correctness]=""
                            [isLoadingMMImage]="false" 
                            [MMImageTHOT]="" 
                            [MMImageCOV]="" 
                            [MMImageCOT]="" 
                            [MMTimeTaken]="" 
                            [MMImageHallucinationScore]="" 
                            [enableSearch]="false">
                        </app-response-comparison>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>